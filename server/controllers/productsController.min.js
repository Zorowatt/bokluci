var Products=require("mongoose").model("Product"),Images=require("mongoose").model("Images"),mongoose=require("mongoose"),db=mongoose.connection,Busboy=require("busboy"),fs=require("fs"),stream=require("streamifier"),gm=require("gm").subClass({imageMagick:true});function randomString(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var r=20;var n="";for(var i=0;i<r;i++){var t=Math.floor(Math.random()*e.length);n+=e.substring(t,t+1)}return n}var cirToLat={"Ё":"YO","Й":"I","Ц":"TS","У":"U","К":"K","Е":"E","Н":"N","Г":"G","Ш":"SH","Щ":"SCH","З":"Z","Х":"H","Ъ":"'","ё":"yo","й":"i","ц":"ts","у":"u","к":"k","е":"e","н":"n","г":"g","ш":"sh","щ":"sch","з":"z","х":"h","ъ":"'","Ф":"F","Ы":"I","В":"V","А":"a","П":"P","Р":"R","О":"O","Л":"L","Д":"D","Ж":"ZH","Э":"E","ф":"f","ы":"i","в":"v","а":"a","п":"p","р":"r","о":"o","л":"l","д":"d","ж":"zh","э":"e","Я":"Ya","Ч":"CH","С":"S","М":"M","И":"I","Т":"T","Ь":"'","Б":"B","Ю":"YU","я":"ya","ч":"ch","с":"s","м":"m","и":"i","т":"t","ь":"'","б":"b","ю":"yu"};var latToCyr={y:"ъ",Y:"Ъ",c:"ц",C:"Ц",q:"я",Q:"Я",a:"а",b:"б",v:"в",w:"в",g:"г",d:"д",e:"е",j:"ж",z:"з",i:"и",k:"к",l:"л",m:"м",n:"н",o:"о",p:"п",r:"р",s:"с",t:"т",u:"у",f:"ф",h:"х",A:"А",B:"Б",V:"В",W:"В",G:"Г",D:"Д",E:"Е",J:"Ж",Z:"З",I:"И",K:"К",L:"Л",M:"М",N:"Н",O:"О",P:"П",R:"Р",S:"С",T:"Т",U:"У",F:"Ф",H:"Х"};function transliterate(e){var r=e.split("");var n=[];var t=[];var a=[];var o=[];for(i=0;i<r.length;i++){if(r[i].charCodeAt(0)>1039&&r[i].charCodeAt(0)<1104){}else{if(r[i]=="i"){if(r[i+1]=="u"){t.push(transFromLatToCyr(r[i]));t.push("у");n.push("ю");i++;continue}}if(r[i]=="i"){if(r[i+1]=="o"){t.push(transFromLatToCyr(r[i]));t.push("о");n.push("йо");i++;continue}}if(r[i]=="o"){if(r[i+1]=="i"){t.push(transFromLatToCyr(r[i]));t.push("и");n.push("ой");i++;continue}}if(r[i]=="t"){if(r[i+1]=="s"){t.push(transFromLatToCyr(r[i]));t.push(transFromLatToCyr(r[i+1]));n.push("ц");i++;continue}if(r[i+1]=="c"){t.push(transFromLatToCyr(r[i]));t.push(transFromLatToCyr(r[i+1]));n.push("ц");i++;continue}}if(r[i]=="c"){if(r[i+1]=="h"){t.push(transFromLatToCyr(r[i]));t.push(transFromLatToCyr(r[i+1]));n.push("ч");i++;continue}}if(r[i]=="i"){if(r[i+1]=="a"){t.push(transFromLatToCyr(r[i]));t.push(transFromLatToCyr(r[i+1]));n.push("я");i++;continue}}if(r[i]=="s"){if(r[i+1]=="h"){if(r[i+2]=="t"){t.push(transFromLatToCyr(r[i]));t.push(transFromLatToCyr(r[i+1]));t.push(transFromLatToCyr(r[i+2]));n.push("щ");i++;i++;continue}else{t.push(transFromLatToCyr(r[i]));t.push(transFromLatToCyr(r[i+1]));n.push("ш");i++;continue}}if(r[i+1]=="t"){t.push(transFromLatToCyr(r[i]));t.push(transFromLatToCyr(r[i+1]));n.push("щ");i++;continue}}t.push(transFromLatToCyr(r[i]));n.push(transFromLatToCyr(r[i]))}}o.push(n.join(""));o.push(t.join(""));o.push(n.join("").replace(/у/g,"ъ"));o.push(t.join("").replace(/у/g,"ъ"));return o}function transFromCyrToLat(e){return e.split("").map(function(e){return cirToLat[e]||e})}function transFromLatToCyr(e){return e.split("").map(function(e){return latToCyr[e]||e})}function escapeRegExp(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"щщ")}module.exports={convertImage:function(e,r,n){var i=new Busboy({headers:e.headers});i.on("file",function(e,n,i,t,a){var o=i.split(".").pop();var s=randomString();var u=randomString();var d={name:s,ready:false,contentType:"image/"+o};Images.create(d,function(e,t){if(e){return console.log("Failed to add new product: "+e)}gm(n,i).noProfile().thumbnail(150,150).toBuffer(o,function(e,n){if(e){return r.end()}var i=stream.createReadStream("data:image/"+o+";base64,"+n.toString("base64")+s+u);i.pipe(r)});gm(n,i).noProfile().resize(150,150).toBuffer(o,function(e,r){if(!e){Images.update({_id:t._id},{dataThumb:r},function(e,r){if(e){console.log("Failed to add new product: "+e)}})}});gm(n,i).noProfile().resize(500,500).toBuffer(o,function(e,r){if(!e){Images.update({_id:t._id},{dataFile:r},function(e,r){if(e){console.log("Failed to add new product: "+e)}})}})})});e.pipe(i)},createProduct:function(e,r,n){var i=new Busboy({headers:e.headers});var t={};i.on("field",function(e,r,n,i){try{t[e]=JSON.parse(r)}catch(a){t[e]=r}});i.on("finish",function(){t.pros[0].dateAdded=new Date;t.cons[0].dateAdded=new Date;t.dateAdded=new Date;t.visited=0;Images.findOneAndUpdate({name:t.thumbnail},{ready:true},function(e,r){Products.create(t,function(e,r){if(e){console.log("Failed to add new product: "+e)}})}),r.end()});e.pipe(i)},next:function(e,r){r.end()},prev:function(e,r){r.end()},getAllProducts:function(e,r,n){e.query.search=escapeRegExp(e.query.search);var t=transliterate(e.query.search);t[0]=t[0]!=""?t[0]:"щщщщщщ";t[1]=t[1]!=""?t[1]:"щщщщщщ";t[2]=t[2]!=""?t[2]:"щщщщщщ";t[3]=t[3]!=""?t[3]:"щщщщщщ";if(e.query.l&&e.query.s){var a={flagIsNew:false,$or:[{name:{$regex:e.query.search,$options:"i"}},{name:{$regex:t[0],$options:"i"}},{name:{$regex:t[1],$options:"i"}},{name:{$regex:t[2],$options:"i"}},{name:{$regex:t[3],$options:"i"}}]};Products.find(a).sort({prosCount:-1}).limit(e.query.l).skip(e.query.s).exec(function(e,n){if(e){console.log("Products can not be loaded: "+e)}if(n!==undefined&&n.length>0){var t=[];for(i=0;i<n.length;i++){var a={};a._id=n[i]._id;a.name=n[i].name;a.pros=n[i].pros;a.cons=n[i].cons;a.visited=n[i].visited;a.thumbnail=n[i].thumbnail;a.dateAdded=n[i].dateAdded;t.push(a)}r.send(t)}else{r.end()}})}else{r.redirect("/")}},getImage:function(e,r,n){if(e.params.id=="na"||e.params.id===undefined){fs.createReadStream("./server/nopicture.jpg").pipe(r);return}Images.findOne({name:e.params.id}).exec(function(e,n){var i=stream.createReadStream(n.dataFile);r.setHeader("Expires",new Date(Date.now()+6048e5));r.setHeader("Content-Type",n.contentType);i.pipe(r)})},getThumb:function(e,r,n){if(e.params.id=="na"||e.params.id===undefined){fs.createReadStream("./server/nopictureThumb.jpg").pipe(r);return}Images.findOne({name:e.params.id}).exec(function(e,n){var i=stream.createReadStream(n.dataThumb);r.setHeader("Expires",new Date(Date.now()+6048e5));r.setHeader("Content-Type",n.contentType);i.pipe(r)})},getProductById:function(e,r,n){e.session.name=e.session.name||56;if(e.cookies.v===undefined){r.cookie("v",randomString(),{maxAge:864e5});var i=1}else{var i=0}Products.findOneAndUpdate({_id:e.params.id},{$inc:{visited:i}}).exec(function(e,n){if(e){r.send({missing:true})}var i={};i.name=n.name;i.pros=n.pros;i.cons=n.cons;i.thumbnail=n.thumbnail;i.dateAdded=n.dateAdded;r.send(i)})},updateProduct:function(e,r,n){var i=e.body;if(!i){r.end();return}if(!!i.pros){i.pros.dateAdded=new Date;i.pros.flagIsNew=true;Products.update({_id:i.id},{$push:{pros:i.pros},flagNewCommentAdded:true},function(e,n){if(e){console.log("Error: "+e);return r.send({success:false})}});return r.send({success:true})}if(!!i.cons){i.cons.dateAdded=new Date;i.cons.flagIsNew=true;Products.update({_id:i.id},{$push:{cons:i.cons},flagNewCommentAdded:true},function(e,n){if(e){console.log("Error: "+e);r.send({success:false})}});return r.send({success:true})}r.send({success:false})}};