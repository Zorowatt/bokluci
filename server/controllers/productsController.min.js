var Products=require("mongoose").model("Product"),mongoose=require("mongoose"),Grid=require("gridfs-stream"),db=mongoose.connection,gfs=Grid(db.db,mongoose.mongo),Busboy=require("busboy"),fs=require("fs"),lwip=require("lwip"),stream=require("streamifier");var randomFileName;function randomString(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var o=20;var r="";for(var n=0;n<o;n++){var t=Math.floor(Math.random()*e.length);r+=e.substring(t,t+1)}return r}module.exports={getAllProducts:function(e,o,r){if(e.query.l&&e.query.s){if(e.query.search.length==0){Products.find({flagIsNew:false}).sort({id:1}).limit(e.query.l).skip(e.query.s).exec(function(e,r){if(e){console.log("Products can not be loaded: "+e)}o.send(r)})}else{var n={flagIsNew:false,keyWords:{$in:[e.query.search]}};Products.find(n).sort({id:1}).limit(e.query.l).skip(e.query.s).exec(function(e,r){if(e){console.log("Products can not be loaded: "+e)}o.send(r)})}}else{o.redirect("/")}},getImage:function(e,o,r){var n=gfs.createReadStream({filename:e.params.id,content_type:"image/*"});n.on("error",function(e){console.log("An error occurred!",e);throw e});n.pipe(o)},getProductById:function(e,o,r){Products.findOne({_id:e.params.id}).exec(function(e,r){if(e){console.log("Product can not be loaded: "+e)}o.send(r)})},createProduct:function(e,o,r){var n=false;var t=new Busboy({headers:e.headers});var i={};t.on("file",function(e,o,r,t,i){n=true;var a=r.split(".").pop();if(a!="jpg"&&a!="jpeg"&&a!="png"){n=false;return}var d=[];o.on("data",function(e){d.push(e)});o.on("end",function(){var e=Buffer.concat(d);var o=500,r=500;lwip.create(o,r,"yellow",function(n,t){lwip.open(e,a,function(e,n){if(e){console.log(e)}var i=n.width(),a=n.height();console.log(i+"-------"+a);if(a==i){a=r;i=o}else{if(i>a){if(i>o){a=Math.floor(r*a/i);i=o}else{a=a*o/i;i=o}}else{if(a>r){i=Math.floor(o*i/a);a=r}else{i=i*r/a;a=r}}}console.log(i+"-------"+a);n.resize(i,a,function(e,n){if(e){console.log(e)}var d=0,s=0;if(i<o){d=Math.floor((o-i)/2)}if(a<r){s=Math.floor((r-a)/2)}t.paste(d,s,n,function(e,o){if(e){console.log(e)}o.toBuffer("jpg",{quality:100},function(e,o){if(e){console.log(e)}stream.createReadStream(o).pipe(gfs.createWriteStream({filename:randomFileName}))})})})})})})});t.on("field",function(e,o,r,n){try{i[e]=JSON.parse(o);if(e=="picture"){randomFileName=randomString();i.picture[0].filename=randomFileName}}catch(t){i[e]=o}});t.on("finish",function(){i.pros[0].dateAdded=new Date;i.cons[0].dateAdded=new Date;i.dateAdded=new Date;if(i.picture){i.picture[0].dateAdded=new Date}Products.create(i,function(e,o){if(e){console.log("Failed to add new product: "+e)}});if(!n){fs.createReadStream("./server/nopicture.jpg").pipe(gfs.createWriteStream({filename:randomFileName}))}o.end()});e.pipe(t)},updateProduct:function(e,o,r){var n=e.body;if(n){o.end();return}if(n.pros){n.pros.dateAdded=new Date;Products.update({_id:n.id},{$push:{pros:n.pros},flagNewCommentAdded:true},function(e,r){if(e){console.log("Error: "+e);return}o.end()})}if(n.cons){n.cons.dateAdded=new Date;Products.update({_id:n.id},{$push:{cons:n.cons},flagNewCommentAdded:true},function(e,r){if(e){console.log("Error: "+e);return}o.end()})}o.end()}};