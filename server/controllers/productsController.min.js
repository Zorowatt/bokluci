var Products=require("mongoose").model("Product"),Images=require("mongoose").model("Images"),mongoose=require("mongoose"),db=mongoose.connection,Busboy=require("busboy"),fs=require("fs"),stream=require("streamifier"),gm=require("gm").subClass({imageMagick:true});function randomString(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var n=20;var r="";for(var a=0;a<n;a++){var t=Math.floor(Math.random()*e.length);r+=e.substring(t,t+1)}return r}module.exports={convertImage:function(e,n,r){var a=new Busboy({headers:e.headers});a.on("file",function(e,r,a,t,o){var d=a.split(".").pop();var i=randomString();var s=randomString();var u={name:i,ready:false,contentType:"image/"+d};Images.create(u,function(e,t){if(e){return console.log("Failed to add new product: "+e)}gm(r,a).noProfile().thumbnail(150,150).toBuffer(d,function(e,r){if(e){return n.end()}var a=stream.createReadStream("data:image/"+d+";base64,"+r.toString("base64")+i+s);a.pipe(n)});gm(r,a).noProfile().resize(150,150).toBuffer(d,function(e,n){if(!e){Images.update({_id:t._id},{dataThumb:n},function(e,n){if(e){console.log("Failed to add new product: "+e)}})}});gm(r,a).noProfile().resize(500,500).toBuffer(d,function(e,n){if(!e){Images.update({_id:t._id},{dataFile:n},function(e,n){if(e){console.log("Failed to add new product: "+e)}})}})})});e.pipe(a)},createProduct:function(e,n,r){var a=new Busboy({headers:e.headers});var t={};a.on("field",function(e,n,r,a){try{t[e]=JSON.parse(n)}catch(o){t[e]=n}});a.on("finish",function(){t.pros[0].dateAdded=new Date;t.cons[0].dateAdded=new Date;t.dateAdded=new Date;Images.findOneAndUpdate({name:t.thumbnail},{ready:true},function(e,n){Products.create(t,function(e,n){if(e){console.log("Failed to add new product: "+e)}})}),n.end()});e.pipe(a)},getAllProducts:function(e,n,r){if(e.query.l&&e.query.s){if(e.query.search.length==0){var a={flagIsNew:false};Products.find(a).sort({prosCount:-1}).limit(e.query.l).skip(e.query.s).exec(function(e,r){if(e){console.log("Products can not be loaded: "+e)}if(r!==undefined&&r.length>0){var a=[];for(i=0;i<r.length;i++){var t={};t._id=r[i]._id;t.name=r[i].name;t.pros=r[i].pros;t.cons=r[i].cons;t.thumbnail=r[i].thumbnail;t.dateAdded=r[i].dateAdded;a.push(t)}n.send(a)}else{n.end()}})}else{var a={flagIsNew:false,name:{$regex:e.query.search,$options:"i"}};Products.find(a).sort({prosCount:-1}).limit(e.query.l).skip(e.query.s).exec(function(e,r){if(e){console.log("Products can not be loaded: "+e)}if(r!==undefined&&r.length>0){var a=[];for(i=0;i<r.length;i++){var t={};t.name=r[i].name;t.pros=r[i].pros;t.cons=r[i].cons;t.thumbnail=r[i].thumbnail;t.dateAdded=r[i].dateAdded;a.push(t)}n.send(a)}})}}else{n.redirect("/")}},getImage:function(e,n,r){if(e.params.id=="na"||e.params.id===undefined){fs.createReadStream("./server/nopicture.jpg").pipe(n);return}Images.findOne({name:e.params.id}).exec(function(e,r){var a=stream.createReadStream(r.dataFile);n.setHeader("Expires",new Date(Date.now()+6048e5));n.setHeader("Content-Type",r.contentType);a.pipe(n)})},getThumb:function(e,n,r){if(e.params.id=="na"||e.params.id===undefined){fs.createReadStream("./server/nopictureThumb.jpg").pipe(n);return}Images.findOne({name:e.params.id}).exec(function(e,r){var a=stream.createReadStream(r.dataThumb);n.setHeader("Expires",new Date(Date.now()+6048e5));n.setHeader("Content-Type",r.contentType);a.pipe(n)})},getProductById:function(e,n,r){Products.findOne({_id:e.params.id}).exec(function(e,r){if(e){n.send({missing:true})}var a={};a.name=r.name;a.pros=r.pros;a.cons=r.cons;a.thumbnail=r.thumbnail;a.dateAdded=r.dateAdded;n.send(a)})},updateProduct:function(e,n,r){var a=e.body;if(!a){n.end();return}if(!!a.pros){a.pros.dateAdded=new Date;a.pros.flagIsNew=true;Products.update({_id:a.id},{$push:{pros:a.pros},flagNewCommentAdded:true},function(e,r){if(e){console.log("Error: "+e);return n.send({success:false})}});return n.send({success:true})}if(!!a.cons){a.cons.dateAdded=new Date;a.cons.flagIsNew=true;Products.update({_id:a.id},{$push:{cons:a.cons},flagNewCommentAdded:true},function(e,r){if(e){console.log("Error: "+e);n.send({success:false})}});return n.send({success:true})}n.send({success:false})}};