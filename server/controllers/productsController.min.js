var Products=require("mongoose").model("Product"),mongoose=require("mongoose"),Grid=require("gridfs-stream"),db=mongoose.connection,gfs=Grid(db.db,mongoose.mongo),Busboy=require("busboy"),fs=require("fs"),lwip=require("lwip"),stream=require("streamifier");function randomString(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var r=20;var o="";for(var n=0;n<r;n++){var t=Math.floor(Math.random()*e.length);o+=e.substring(t,t+1)}return o}module.exports={getAllProducts:function(e,r,o){if(e.query.l&&e.query.s){if(e.query.search.length==0){Products.find({flagIsNew:false}).sort({id:1}).limit(e.query.l).skip(e.query.s).exec(function(e,o){if(e){console.log("Products can not be loaded: "+e)}r.send(o)})}else{var n={flagIsNew:false,keyWords:{$in:[e.query.search]}};Products.find(n).sort({id:1}).limit(e.query.l).skip(e.query.s).exec(function(e,o){if(e){console.log("Products can not be loaded: "+e)}r.send(o)})}}else{r.redirect("/")}},getImage:function(e,r,o){var n=gfs.createReadStream({filename:e.params.id});n.on("error",function(e){console.log("An error occurred!",e);fs.createReadStream("./server/nopictureThumb.jpg").pipe(r)});n.pipe(r)},getProductById:function(e,r,o){Products.findOne({_id:e.params.id}).exec(function(e,o){if(e){o={missing:true}}r.send(o)})},convertImage:function(e,r,o){var n=new Busboy({headers:e.headers});var t=[];n.on("file",function(e,o,n,i,a){var f=n.split(".").pop();if(f!="jpg"&&f!="jpeg"&&f!="png"){return r.end()}o.on("data",function(e){t.push(e)});o.on("end",function(){var e=Buffer.concat(t);lwip.open(e,f,function(e,o){if(e){console.log(e);return r.end()}var n=o.width(),t=o.height(),i=100,a=100;if(t==n){t=a;n=i}else{if(n>t){if(n>i){t=Math.floor(a*t/n);n=i}else{t=t*i/n;n=i}}else{if(t>a){n=Math.floor(i*n/t);t=a}else{n=n*a/t;t=a}}}o.resize(n,t,function(e,o){if(e){console.log(e);return r.end()}var f=0,s=0;if(n<i){f=Math.floor((i-n)/2)}if(t<a){s=Math.floor((a-t)/2)}o.toBuffer("jpg",{quality:100},function(e,o){if(e){console.log(e);return r.end()}var n=stream.createReadStream("data:image/jpg;base64,"+o.toString("base64"));n.on("error",function(e){console.log("An error occurred!",e);return r.end()});n.on("end",function(){ready=true});n.pipe(r)})})})})});e.pipe(n)},createProduct:function(e,r,o){var n=false;var t=new Busboy({headers:e.headers});var i={};var a=randomString();var f=randomString();t.on("file",function(e,r,o,t,i){n=true;var s=o.split(".").pop();if(s!="jpg"&&s!="jpeg"&&s!="png"){n=false;return}var d=[];r.on("data",function(e){d.push(e)});r.on("end",function(){var e=Buffer.concat(d);lwip.open(e,s,function(e,r){if(e){console.log(e);n=false;return}var o=r.width(),t=r.height(),i=500,s=500,d=100,u=100;lwip.create(i,s,"white",function(e,c){if(e){console.log(e);n=false;return}if(t==o){t=s;o=i}else{if(o>t){if(o>i){t=Math.floor(s*t/o);o=i}else{t=t*i/o;o=i}}else{if(t>s){o=Math.floor(i*o/t);t=s}else{o=o*s/t;t=s}}}r.resize(o,t,function(e,r){if(e){console.log(e);n=false;return}var l=0,p=0;if(o<i){l=Math.floor((i-o)/2)}if(t<s){p=Math.floor((s-t)/2)}c.paste(l,p,r,function(e,r){if(e){console.log(e);n=false;return}r.toBuffer("jpg",{quality:100},function(e,o){if(e){console.log(e);n=false;return}stream.createReadStream(o).pipe(gfs.createWriteStream({filename:a}));r.resize(d,u,function(e,r){if(e){console.log(e);n=false;return}r.toBuffer("jpg",{quality:100},function(e,r){if(e){console.log(e);n=false;return}stream.createReadStream(r).pipe(gfs.createWriteStream({filename:f}))})})})})})})})})});t.on("field",function(e,r,o,n){try{i[e]=JSON.parse(r);if(e=="picture"){i.picture[0].filename=a;i.thumbnail=f}}catch(t){i[e]=r}});t.on("finish",function(){i.pros[0].dateAdded=new Date;i.cons[0].dateAdded=new Date;i.dateAdded=new Date;if(i.picture){i.picture[0].dateAdded=new Date}Products.create(i,function(e,r){if(e){console.log("Failed to add new product: "+e)}});if(!n){fs.createReadStream("./server/nopicture.jpg").pipe(gfs.createWriteStream({filename:a}));fs.createReadStream("./server/nopictureThumb.jpg").pipe(gfs.createWriteStream({filename:f}))}r.end()});e.pipe(t)},updateProduct:function(e,r,o){var n=e.body;if(n){r.end();return}if(n.pros){n.pros.dateAdded=new Date;Products.update({_id:n.id},{$push:{pros:n.pros},flagNewCommentAdded:true},function(e,o){if(e){console.log("Error: "+e);return}r.end()})}if(n.cons){n.cons.dateAdded=new Date;Products.update({_id:n.id},{$push:{cons:n.cons},flagNewCommentAdded:true},function(e,o){if(e){console.log("Error: "+e);return}r.end()})}r.end()}};