var Products=require("mongoose").model("Product"),mongoose=require("mongoose"),Grid=require("gridfs-stream"),db=mongoose.connection,gfs=Grid(db.db,mongoose.mongo),Busboy=require("busboy"),fs=require("fs");var randomFileName;function randomString(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz{}[]$^*";var r=15;var o="";for(var n=0;n<r;n++){var d=Math.floor(Math.random()*e.length);o+=e.substring(d,d+1)}return o}module.exports={getAllProducts:function(e,r,o){if(e.query.l&&e.query.s){if(e.query.search.length==0){Products.find({flagIsNew:false}).sort({id:1}).limit(e.query.l).skip(e.query.s).exec(function(e,o){if(e){console.log("Products can not be loaded: "+e)}r.send(o)})}else{var n={flagIsNew:false,keyWords:{$in:[e.query.search]}};Products.find(n).sort({id:1}).limit(e.query.l).skip(e.query.s).exec(function(e,o){if(e){console.log("Products can not be loaded: "+e)}r.send(o)})}}else{r.redirect("/")}},getImage:function(e,r,o){var n=gfs.createReadStream({filename:e.params.id,content_type:"image/*"});n.on("error",function(e){console.log("An error occurred!",e);throw e});n.pipe(r)},getProductById:function(e,r,o){Products.findOne({_id:e.params.id}).exec(function(e,o){if(e){console.log("Product can not be loaded: "+e)}r.send(o)})},createProduct:function(e,r,o){var n=false;var d=new Busboy({headers:e.headers});var t={};d.on("file",function(e,r,o,d,t){n=true;r.pipe(gfs.createWriteStream({filename:randomFileName}))});d.on("field",function(e,r,o,n){try{t[e]=JSON.parse(r);if(e=="picture"){randomFileName=randomString();t.picture[0].filename=randomFileName}}catch(d){t[e]=r}});d.on("finish",function(){t.pros[0].dateAdded=new Date;t.cons[0].dateAdded=new Date;t.dateAdded=new Date;if(t.picture){t.picture[0].dateAdded=new Date}Products.create(t,function(e,r){if(e){console.log("Failed to add new product: "+e);return}});if(!n){fs.createReadStream("./server/nopicture.jpg").pipe(gfs.createWriteStream({filename:randomFileName}))}r.end()});e.pipe(d)},updateProduct:function(e,r,o){var n=e.body;if(n.pros){n.pros.dateAdded=new Date;Products.update({_id:n.id},{$push:{pros:n.pros},flagNewCommentAdded:true},function(e,o){if(e){console.log("Error: "+e);return}r.end()})}if(n.cons){n.cons.dateAdded=new Date;Products.update({_id:n.id},{$push:{cons:n.cons},flagNewCommentAdded:true},function(e,o){if(e){console.log("Error: "+e);return}r.end()})}r.end()}};