var Products=require("mongoose").model("Product"),Images=require("mongoose").model("Images"),mongoose=require("mongoose"),db=mongoose.connection,Busboy=require("busboy"),fs=require("fs"),stream=require("streamifier"),gm=require("gm").subClass({imageMagick:true});function randomString(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var n=20;var r="";for(var t=0;t<n;t++){var a=Math.floor(Math.random()*e.length);r+=e.substring(a,a+1)}return r}var cirToLat={"Ё":"YO","Й":"I","Ц":"TS","У":"U","К":"K","Е":"E","Н":"N","Г":"G","Ш":"SH","Щ":"SCH","З":"Z","Х":"H","Ъ":"'","ё":"yo","й":"i","ц":"ts","у":"u","к":"k","е":"e","н":"n","г":"g","ш":"sh","щ":"sch","з":"z","х":"h","ъ":"'","Ф":"F","Ы":"I","В":"V","А":"a","П":"P","Р":"R","О":"O","Л":"L","Д":"D","Ж":"ZH","Э":"E","ф":"f","ы":"i","в":"v","а":"a","п":"p","р":"r","о":"o","л":"l","д":"d","ж":"zh","э":"e","Я":"Ya","Ч":"CH","С":"S","М":"M","И":"I","Т":"T","Ь":"'","Б":"B","Ю":"YU","я":"ya","ч":"ch","с":"s","м":"m","и":"i","т":"t","ь":"'","б":"b","ю":"yu"};var latToCyr={a:"а",b:"б",v:"в",w:"в",g:"г",d:"д",e:"е",j:"ж",z:"з",i:"и",k:"к",l:"л",m:"м",n:"н",o:"о",p:"п",r:"р",s:"с",t:"т",u:"у",f:"ф",h:"х",A:"А",B:"Б",V:"В",W:"В",G:"Г",D:"Д",E:"Е",J:"Ж",Z:"З",I:"И",K:"К",L:"Л",M:"М",N:"Н",O:"О",P:"П",R:"Р",S:"С",T:"Т",U:"У",F:"Ф",H:"Х"};function transliterate(e){var n=e.split("");var r=[];for(i=0;i<n.length;i++){if(n[i].charCodeAt(0)>1039&&n[i].charCodeAt(0)<1104){r.push(transFromCyrToLat(n[i]))}else{r.push(transFromLatToCyr(n[i]))}}return r.join("")}function transFromCyrToLat(e){return e.split("").map(function(e){return cirToLat[e]||e})}function transFromLatToCyr(e){return e.split("").map(function(e){return latToCyr[e]||e})}module.exports={convertImage:function(e,n,r){var t=new Busboy({headers:e.headers});t.on("file",function(e,r,t,a,o){var i=t.split(".").pop();var s=randomString();var d=randomString();var u={name:s,ready:false,contentType:"image/"+i};Images.create(u,function(e,a){if(e){return console.log("Failed to add new product: "+e)}gm(r,t).noProfile().thumbnail(150,150).toBuffer(i,function(e,r){if(e){return n.end()}var t=stream.createReadStream("data:image/"+i+";base64,"+r.toString("base64")+s+d);t.pipe(n)});gm(r,t).noProfile().resize(150,150).toBuffer(i,function(e,n){if(!e){Images.update({_id:a._id},{dataThumb:n},function(e,n){if(e){console.log("Failed to add new product: "+e)}})}});gm(r,t).noProfile().resize(500,500).toBuffer(i,function(e,n){if(!e){Images.update({_id:a._id},{dataFile:n},function(e,n){if(e){console.log("Failed to add new product: "+e)}})}})})});e.pipe(t)},createProduct:function(e,n,r){var t=new Busboy({headers:e.headers});var a={};t.on("field",function(e,n,r,t){try{a[e]=JSON.parse(n)}catch(o){a[e]=n}});t.on("finish",function(){a.pros[0].dateAdded=new Date;a.cons[0].dateAdded=new Date;a.dateAdded=new Date;a.visited=0;Images.findOneAndUpdate({name:a.thumbnail},{ready:true},function(e,n){Products.create(a,function(e,n){if(e){console.log("Failed to add new product: "+e)}})}),n.end()});e.pipe(t)},next:function(e,n){n.end()},prev:function(e,n){n.end()},getAllProducts:function(e,n,r){var t=transliterate(e.query.search);if(e.query.l&&e.query.s){var a={flagIsNew:false,$or:[{name:{$regex:e.query.search,$options:"i"}},{name:{$regex:t,$options:"i"}}]};Products.find(a).sort({prosCount:-1}).limit(e.query.l).skip(e.query.s).exec(function(e,r){if(e){console.log("Products can not be loaded: "+e)}if(r!==undefined&&r.length>0){var t=[];for(i=0;i<r.length;i++){var a={};a._id=r[i]._id;a.name=r[i].name;a.pros=r[i].pros;a.cons=r[i].cons;a.visited=r[i].visited;a.thumbnail=r[i].thumbnail;a.dateAdded=r[i].dateAdded;t.push(a)}n.send(t)}else{n.end()}})}else{n.redirect("/")}},getImage:function(e,n,r){if(e.params.id=="na"||e.params.id===undefined){fs.createReadStream("./server/nopicture.jpg").pipe(n);return}Images.findOne({name:e.params.id}).exec(function(e,r){var t=stream.createReadStream(r.dataFile);n.setHeader("Expires",new Date(Date.now()+6048e5));n.setHeader("Content-Type",r.contentType);t.pipe(n)})},getThumb:function(e,n,r){if(e.params.id=="na"||e.params.id===undefined){fs.createReadStream("./server/nopictureThumb.jpg").pipe(n);return}Images.findOne({name:e.params.id}).exec(function(e,r){var t=stream.createReadStream(r.dataThumb);n.setHeader("Expires",new Date(Date.now()+6048e5));n.setHeader("Content-Type",r.contentType);t.pipe(n)})},getProductById:function(e,n,r){e.session.name=e.session.name||56;if(e.cookies.v===undefined){n.cookie("v",randomString(),{maxAge:864e5});var t=1}else{var t=0}Products.findOneAndUpdate({_id:e.params.id},{$inc:{visited:t}}).exec(function(e,r){if(e){n.send({missing:true})}var t={};t.name=r.name;t.pros=r.pros;t.cons=r.cons;t.thumbnail=r.thumbnail;t.dateAdded=r.dateAdded;n.send(t)})},updateProduct:function(e,n,r){var t=e.body;if(!t){n.end();return}if(!!t.pros){t.pros.dateAdded=new Date;t.pros.flagIsNew=true;Products.update({_id:t.id},{$push:{pros:t.pros},flagNewCommentAdded:true},function(e,r){if(e){console.log("Error: "+e);return n.send({success:false})}});return n.send({success:true})}if(!!t.cons){t.cons.dateAdded=new Date;t.cons.flagIsNew=true;Products.update({_id:t.id},{$push:{cons:t.cons},flagNewCommentAdded:true},function(e,r){if(e){console.log("Error: "+e);n.send({success:false})}});return n.send({success:true})}n.send({success:false})}};