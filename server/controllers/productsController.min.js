var Products=require("mongoose").model("Product"),mongoose=require("mongoose"),Grid=require("gridfs-stream"),db=mongoose.connection,gfs=Grid(db.db,mongoose.mongo),Busboy=require("busboy"),fs=require("fs"),lwip=require("lwip"),stream=require("streamifier"),gm=require("gm").subClass({imageMagick:true});function randomString(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var r=20;var n="";for(var o=0;o<r;o++){var t=Math.floor(Math.random()*e.length);n+=e.substring(t,t+1)}return n}module.exports={convertImage:function(e,r,n){var o=new Busboy({headers:e.headers});o.on("file",function(e,n,o,t,i){var a=o.split(".").pop();var d=[];n.on("data",function(e){d.push(e)});n.on("end",function(){var e=Buffer.concat(d);gm(e,o).noProfile().thumbnail(100,100).toBuffer(a,function(e,n){if(e){console.log(e);return r.end()}var o=stream.createReadStream("data:image/"+a+";base64,"+n.toString("base64"));o.pipe(r)})})});e.pipe(o)},createProduct:function(e,r,n){var o=false;var t=new Busboy({headers:e.headers});var i={};var a=randomString();var d=randomString();t.on("file",function(e,r,n,t,i){o=true;var s=n.split(".").pop();gm(r,n).noProfile().thumbnail(150,150).stream(function(e,r,n){if(e){return o=false}r.pipe(gfs.createWriteStream({filename:d}))});gm(r,n).noProfile().resize(500,500).stream(function(e,r,n){if(e){return o=false}r.pipe(gfs.createWriteStream({filename:a}))})});t.on("field",function(e,r,n,o){try{i[e]=JSON.parse(r);if(e=="picture"){i.picture[0].filename=a;i.thumbnail=d}}catch(t){i[e]=r}});t.on("finish",function(){i.pros[0].dateAdded=new Date;i.cons[0].dateAdded=new Date;i.dateAdded=new Date;if(i.picture){i.picture[0].dateAdded=new Date}Products.create(i,function(e,r){if(e){console.log("Failed to add new product: "+e)}});if(!o){fs.createReadStream("./server/nopicture.jpg").pipe(gfs.createWriteStream({filename:a}));fs.createReadStream("./server/nopictureThumb.jpg").pipe(gfs.createWriteStream({filename:d}))}r.end()});e.pipe(t)},getAllProducts:function(e,r,n){if(e.query.l&&e.query.s){if(e.query.search.length==0){Products.find({flagIsNew:false}).sort({id:1}).limit(e.query.l).skip(e.query.s).exec(function(e,n){if(e){console.log("Products can not be loaded: "+e)}r.send(n)})}else{var o={flagIsNew:false,keyWords:{$in:[e.query.search]}};Products.find(o).sort({id:1}).limit(e.query.l).skip(e.query.s).exec(function(e,n){if(e){console.log("Products can not be loaded: "+e)}r.send(n)})}}else{r.redirect("/")}},getImage:function(e,r,n){var o=gfs.createReadStream({filename:e.params.id});o.on("error",function(e){console.log("An error occurred!",e);fs.createReadStream("./server/nopictureThumb.jpg").pipe(r)});o.pipe(r)},getProductById:function(e,r,n){Products.findOne({_id:e.params.id}).exec(function(e,n){if(e){n={missing:true}}r.send(n)})},updateProduct:function(e,r,n){var o=e.body;if(o){r.end();return}if(o.pros){o.pros.dateAdded=new Date;Products.update({_id:o.id},{$push:{pros:o.pros},flagNewCommentAdded:true},function(e,n){if(e){console.log("Error: "+e);return}r.end()})}if(o.cons){o.cons.dateAdded=new Date;Products.update({_id:o.id},{$push:{cons:o.cons},flagNewCommentAdded:true},function(e,n){if(e){console.log("Error: "+e);return}r.end()})}r.end()}};