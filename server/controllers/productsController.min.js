var Products=require("mongoose").model("Product"),Images=require("mongoose").model("Images"),mongoose=require("mongoose"),db=mongoose.connection,Busboy=require("busboy"),fs=require("fs"),stream=require("streamifier"),gm=require("gm").subClass({imageMagick:true});function randomString(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var n=20;var r="";for(var t=0;t<n;t++){var a=Math.floor(Math.random()*e.length);r+=e.substring(a,a+1)}return r}module.exports={convertImage:function(e,n,r){var t=new Busboy({headers:e.headers});t.on("file",function(e,r,t,a,o){var d=t.split(".").pop();var i=randomString();var s=randomString();var u={name:i,ready:false,contentType:"image/"+d};Images.create(u,function(e,a){if(e){return console.log("Failed to add new product: "+e)}gm(r,t).noProfile().thumbnail(150,150).toBuffer(d,function(e,r){if(e){return n.end()}var t=stream.createReadStream("data:image/"+d+";base64,"+r.toString("base64")+i+s);t.pipe(n)});gm(r,t).noProfile().resize(150,150).toBuffer(d,function(e,n){if(!e){Images.update({_id:a._id},{dataThumb:n},function(e,n){if(e){console.log("Failed to add new product: "+e)}})}});gm(r,t).noProfile().resize(500,500).toBuffer(d,function(e,n){if(!e){Images.update({_id:a._id},{dataFile:n},function(e,n){if(e){console.log("Failed to add new product: "+e)}})}})})});e.pipe(t)},createProduct:function(e,n,r){var t=new Busboy({headers:e.headers});var a={};t.on("field",function(e,n,r,t){try{a[e]=JSON.parse(n)}catch(o){a[e]=n}});t.on("finish",function(){a.pros[0].dateAdded=new Date;a.cons[0].dateAdded=new Date;a.dateAdded=new Date;Images.findOneAndUpdate({name:a.thumbnail},{ready:true},function(e,n){Products.create(a,function(e,n){if(e){console.log("Failed to add new product: "+e)}})}),n.end()});e.pipe(t)},getAllProducts:function(e,n,r){if(e.query.l&&e.query.s){if(e.query.search.length==0){var t={flagIsNew:false};Products.find(t).sort({prosCount:-1}).limit(e.query.l).skip(e.query.s).exec(function(e,r){if(e){console.log("Products can not be loaded: "+e)}if(r.length>0){var t=[];for(i=0;i<r.length;i++){var a={};a._id=r[i]._id;a.name=r[i].name;a.pros=r[i].pros;a.cons=r[i].cons;a.thumbnail=r[i].thumbnail;a.dateAdded=r[i].dateAdded;t.push(a)}n.send(t)}else{n.end()}})}else{var t={flagIsNew:false,name:{$regex:e.query.search,$options:"i"}};Products.find(t).sort({prosCount:-1}).limit(e.query.l).skip(e.query.s).exec(function(e,r){if(e){console.log("Products can not be loaded: "+e)}if(r.length>0){var t=[];for(i=0;i<r.length;i++){var a={};a.name=r[i].name;a.pros=r[i].pros;a.cons=r[i].cons;a.thumbnail=r[i].thumbnail;a.dateAdded=r[i].dateAdded;t.push(a)}}n.send(t)})}}else{n.redirect("/")}},getImage:function(e,n,r){if(e.params.id=="na"||e.params.id===undefined){fs.createReadStream("./server/nopicture.jpg").pipe(n);return}Images.findOne({name:e.params.id}).exec(function(e,r){var t=stream.createReadStream(r.dataFile);n.setHeader("Expires",new Date(Date.now()+6048e5));n.setHeader("Content-Type",r.contentType);t.pipe(n)})},getThumb:function(e,n,r){if(e.params.id=="na"||e.params.id===undefined){fs.createReadStream("./server/nopictureThumb.jpg").pipe(n);return}Images.findOne({name:e.params.id}).exec(function(e,r){var t=stream.createReadStream(r.dataThumb);n.setHeader("Expires",new Date(Date.now()+6048e5));n.setHeader("Content-Type",r.contentType);t.pipe(n)})},getProductById:function(e,n,r){Products.findOne({_id:e.params.id}).exec(function(e,r){if(e){n.send({missing:true})}var t={};t.name=r.name;t.pros=r.pros;t.cons=r.cons;t.thumbnail=r.thumbnail;t.dateAdded=r.dateAdded;n.send(t)})},updateProduct:function(e,n,r){var t=e.body;if(!t){n.end();return}if(!!t.pros){t.pros.dateAdded=new Date;t.pros.flagIsNew=true;Products.update({_id:t.id},{$push:{pros:t.pros},flagNewCommentAdded:true},function(e,r){if(e){console.log("Error: "+e);return}console.log("Product with _id: "+t.id+"   UPDATED");n.end()})}if(!!t.cons){t.cons.dateAdded=new Date;t.cons.flagIsNew=true;Products.update({_id:t.id},{$push:{cons:t.cons},flagNewCommentAdded:true},function(e,r){if(e){console.log("Error: "+e);return}n.end()})}n.end()}};