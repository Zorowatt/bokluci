var Products=require("mongoose").model("Product"),Images=require("mongoose").model("Images"),mongoose=require("mongoose"),db=mongoose.connection,Busboy=require("busboy"),fs=require("fs"),stream=require("streamifier"),gm=require("gm").subClass({imageMagick:true});function randomString(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var i=20;var n="";for(var r=0;r<i;r++){var t=Math.floor(Math.random()*e.length);n+=e.substring(t,t+1)}return n}var cirToLat={"Ё":"YO","Й":"I","Ц":"TS","У":"U","К":"K","Е":"E","Н":"N","Г":"G","Ш":"SH","Щ":"SCH","З":"Z","Х":"H","Ъ":"'","ё":"yo","й":"i","ц":"ts","у":"u","к":"k","е":"e","н":"n","г":"g","ш":"sh","щ":"sch","з":"z","х":"h","ъ":"'","Ф":"F","Ы":"I","В":"V","А":"a","П":"P","Р":"R","О":"O","Л":"L","Д":"D","Ж":"ZH","Э":"E","ф":"f","ы":"i","в":"v","а":"a","п":"p","р":"r","о":"o","л":"l","д":"d","ж":"zh","э":"e","Я":"Ya","Ч":"CH","С":"S","М":"M","И":"I","Т":"T","Ь":"'","Б":"B","Ю":"YU","я":"ya","ч":"ch","с":"s","м":"m","и":"i","т":"t","ь":"'","б":"b","ю":"yu"};var latToCyr={y:"ъ",Y:"Ъ",c:"ц",C:"Ц",q:"я",Q:"Я",a:"а",b:"б",v:"в",w:"в",g:"г",d:"д",e:"е",j:"ж",z:"з",i:"и",k:"к",l:"л",m:"м",n:"н",o:"о",p:"п",r:"р",s:"с",t:"т",u:"у",f:"ф",h:"х",A:"А",B:"Б",V:"В",W:"В",G:"Г",D:"Д",E:"Е",J:"Ж",Z:"З",I:"И",K:"К",L:"Л",M:"М",N:"Н",O:"О",P:"П",R:"Р",S:"С",T:"Т",U:"У",F:"Ф",H:"Х"};function transliterate(e){var n=e.split("");var r=[];var t=[];var a=[];var o=[];for(i=0;i<n.length;i++){if(n[i].charCodeAt(0)>64&&n[i].charCodeAt(0)<91||n[i].charCodeAt(0)>96&&n[i].charCodeAt(0)<123){if(n[i]=="e"){if(n[i+1]=="j"){t.push("еж");r.push("ей");i++;continue}}if(n[i]=="e"){if(n[i+1]=="i"){t.push("еи");r.push("ей");i++;continue}}if(n[i]=="a"){if(n[i+1]=="j"){t.push("аж");r.push("ай");i++;continue}}if(n[i]=="a"){if(n[i+1]=="i"){t.push("аи");r.push("ай");i++;continue}}if(n[i]=="i"){if(n[i+1]=="u"){t.push("иу");r.push("ю");i++;continue}}if(n[i]=="j"){if(n[i+1]=="u"){t.push("жу");r.push("ю");i++;continue}}if(n[i]=="i"){if(n[i+1]=="o"){t.push("ио");r.push("йо");i++;continue}}if(n[i]=="j"){if(n[i+1]=="o"){t.push("жо");r.push("йо");i++;continue}}if(n[i]=="o"){if(n[i+1]=="i"){t.push("ои");r.push("ой");i++;continue}}if(n[i]=="t"){if(n[i+1]=="s"){t.push("тс");r.push("ц");i++;continue}if(n[i+1]=="c"){t.push("тц");r.push("ц");i++;continue}}if(n[i]=="c"){if(n[i+1]=="h"){t.push("цх");r.push("ч");i++;continue}}if(n[i]=="i"){if(n[i+1]=="a"){t.push("иа");r.push("я");i++;continue}}if(n[i]=="j"){if(n[i+1]=="a"){t.push("жа");r.push("я");i++;continue}}if(n[i]=="s"){if(n[i+1]=="h"){if(n[i+2]=="t"){t.push("схт");r.push("щ");i++;i++;continue}else{t.push("сх");r.push("ш");i++;continue}}if(n[i+1]=="t"){t.push("ст");r.push("щ");i++;continue}}t.push(transFromLatToCyr(n[i]));r.push(transFromLatToCyr(n[i]))}}o.push(r.join(""));o.push(t.join(""));o.push(r.join("").replace(/у/g,"ъ"));o.push(t.join("").replace(/у/g,"ъ"));return o}function transFromCyrToLat(e){return e.split("").map(function(e){return cirToLat[e]||e})}function transFromLatToCyr(e){return e.split("").map(function(e){return latToCyr[e]||e})}function escapeRegExp(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"щщ")}module.exports={convertImage:function(e,i,n){var r=new Busboy({headers:e.headers});r.on("file",function(e,n,r,t,a){var o=r.split(".").pop();var s=randomString();var u=randomString();var d={name:s,ready:false,contentType:"image/"+o};Images.create(d,function(e,t){if(e){return console.log("Failed to add new product: "+e)}gm(n,r).noProfile().thumbnail(150,150).toBuffer(o,function(e,n){if(e){return i.end()}var r=stream.createReadStream("data:image/"+o+";base64,"+n.toString("base64")+s+u);r.pipe(i)});gm(n,r).noProfile().resize(150,150).toBuffer(o,function(e,i){if(!e){Images.update({_id:t._id},{dataThumb:i},function(e,i){if(e){console.log("Failed to add new product: "+e)}})}});gm(n,r).noProfile().resize(500,500).toBuffer(o,function(e,i){if(!e){Images.update({_id:t._id},{dataFile:i},function(e,i){if(e){console.log("Failed to add new product: "+e)}})}})})});e.pipe(r)},createProduct:function(e,i,n){var r=new Busboy({headers:e.headers});var t={};r.on("field",function(e,i,n,r){try{t[e]=JSON.parse(i)}catch(a){t[e]=i}});r.on("finish",function(){t.pros[0].dateAdded=new Date;t.cons[0].dateAdded=new Date;t.dateAdded=new Date;t.visited=0;Images.findOneAndUpdate({name:t.thumbnail},{ready:true},function(e,i){Products.create(t,function(e,i){if(e){console.log("Failed to add new product: "+e)}})}),i.end()});e.pipe(r)},next:function(e,i){i.end()},prev:function(e,i){i.end()},getAllProducts:function(e,n,r){e.query.search=escapeRegExp(e.query.search);var t=transliterate(e.query.search);t[0]=t[0]!=""?t[0]:"щщщщщщ";t[1]=t[1]!=""?t[1]:"щщщщщщ";t[2]=t[2]!=""?t[2]:"щщщщщщ";t[3]=t[3]!=""?t[3]:"щщщщщщ";var a=e.query.l;var o=e.query.s;if(o<0){o=0}if(a<1){a=1}if(a>20){a=20}if(e.query.l&&e.query.s){var s={flagIsNew:false,$or:[{name:{$regex:e.query.search,$options:"i"}},{name:{$regex:t[0],$options:"i"}},{name:{$regex:t[1],$options:"i"}},{name:{$regex:t[2],$options:"i"}},{name:{$regex:t[3],$options:"i"}}]};Products.find(s).sort({prosCount:-1}).limit(a).skip(o).exec(function(e,r){if(e){console.log("Products can not be loaded: "+e)}if(r!==undefined&&r.length>0){var t=[];for(i=0;i<r.length;i++){var a={};a._id=r[i]._id;a.name=r[i].name;a.pros=r[i].pros;a.cons=r[i].cons;a.visited=r[i].visited;a.thumbnail=r[i].thumbnail;a.dateAdded=r[i].dateAdded;t.push(a)}n.send(t)}else{n.end()}})}else{n.redirect("/")}},getImage:function(e,i,n){if(e.params.id=="na"||e.params.id===undefined){fs.createReadStream("./server/nopicture.jpg").pipe(i);return}Images.findOne({name:e.params.id}).exec(function(e,n){var r=stream.createReadStream(n.dataFile);i.setHeader("Expires",new Date(Date.now()+6048e5));i.setHeader("Content-Type",n.contentType);r.pipe(i)})},getThumb:function(e,i,n){if(e.params.id=="na"||e.params.id===undefined){fs.createReadStream("./server/nopictureThumb.jpg").pipe(i);return}Images.findOne({name:e.params.id}).exec(function(e,n){var r=stream.createReadStream(n.dataThumb);i.setHeader("Expires",new Date(Date.now()+6048e5));i.setHeader("Content-Type",n.contentType);r.pipe(i)})},getProductById:function(e,i,n){e.session.name=e.session.name||56;if(e.cookies.v===undefined){i.cookie("v",randomString(),{maxAge:864e5});var r=1}else{var r=0}Products.findOneAndUpdate({_id:e.params.id},{$inc:{visited:r}}).exec(function(e,n){if(e){i.send({missing:true})}var r={};r.name=n.name;r.pros=n.pros;r.cons=n.cons;r.thumbnail=n.thumbnail;r.dateAdded=n.dateAdded;i.send(r)})},updateProduct:function(e,i,n){var r=e.body;if(!r){i.end();return}if(!!r.pros){r.pros.dateAdded=new Date;r.pros.flagIsNew=true;Products.update({_id:r.id},{$push:{pros:r.pros},flagNewCommentAdded:true},function(e,n){if(e){console.log("Error: "+e);return i.send({success:false})}});return i.send({success:true})}if(!!r.cons){r.cons.dateAdded=new Date;r.cons.flagIsNew=true;Products.update({_id:r.id},{$push:{cons:r.cons},flagNewCommentAdded:true},function(e,n){if(e){console.log("Error: "+e);i.send({success:false})}});return i.send({success:true})}i.send({success:false})}};