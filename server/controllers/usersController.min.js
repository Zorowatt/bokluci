var Users=require("mongoose").model("Users"),passport=require("passport"),localPassport=require("passport-local"),crypto=require("crypto"),GoogleStrategy=require("passport-google").Strategy,nodemailer=require("nodemailer"),smtpTransport=require("nodemailer-smtp-transport");passport.use(new localPassport(function(e,r,o){Users.findOne({username:e}).exec(function(e,n){if(e){console.log("Error loading user: "+e);return}if(n&&n.confirmedEmail&&n.authenticate(r)){return o(null,n)}else{return o(null,false)}})}));passport.serializeUser(function(e,r){if(e){r(null,e._id)}});passport.deserializeUser(function(e,r){Users.findOne({_id:e}).exec(function(e,o){if(o){return r(null,o)}else{return r(null,false)}})});function generateSalt(){return crypto.randomBytes(128).toString("base64")}function generateHashedPassword(e,r){var o=crypto.createHmac("sha1",e);return o.update(r).digest("hex")}function randomString(e){var r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var o=e;var n="";for(var s=0;s<o;s++){var t=Math.floor(Math.random()*r.length);n+=r.substring(t,t+1)}return n}module.exports={userAuth:function(e,r,o){var n=passport.authenticate("local",function(n,s){if(n)return o(n);if(!s)r.send({success:false});e.logIn(s,function(e){if(e)return o(e);r.send({success:true,user:{username:s.username}})})});n(e,r,o)},userLogout:function(e,r,o){e.logOut();r.send({success:true})},createUser:function(e,r,o){var n=e.body;n.salt=generateSalt();n.hashPass=generateHashedPassword(n.salt,n.password);n.confirmedEmail=false;n.randomIdForEmailConfirmation=randomString(40);var s=new Date;n.expirationConfirmationTime=s.setHours(s.getHours()+24);n.host=e.get("host");Users.create(n,function(o,s){if(o){return r.send({success:false,reason:o.toString()})}var t="http://"+e.get("host")+"/verify?id="+n.randomIdForEmailConfirmation;var a=nodemailer.createTransport(smtpTransport({service:"Gmail",auth:{user:"deffered1234@gmail.com",pass:"deffered4321"},tls:{rejectUnauthorized:false}}));var i={to:n.email,subject:"Please confirm your Email account!",html:"Hello,<br> Please Click on the link to verify your email.<br><a href="+t+">Click here to verify</a><br> The confirmation should be done within 24 hours!"};a.sendMail(i,function(e,o){if(e){console.log(e);return r.send({success:false,reason:e.toString()})}else{r.send({success:true,reason:"Confirmation Message has been sent to your E-mail!"})}})})},verifyUser:function(e,r,o){Users.findOne({randomIdForEmailConfirmation:e.query.id}).exec(function(o,n){if(o){console.log("No such user exists! ");r.end("<h1>No such user exists!")}if(n){if(e.protocol+"://"+e.get("host")=="http://"+n.host){console.log("Domain is matched. Information is from Authentic email");var s=new Date;if(s>n.expirationConfirmationTime&&!n.confirmedEmail){Users.remove({_id:n._id},function(e,r){if(e){console.log("Error after user removing: "+e)}});r.end("<h1>Confirmation is too late.<br> You have to create new account!");return}Users.update({_id:n._id},{confirmedEmail:true},function(e,o){if(e){console.log("Error after user confirmation e-mail: "+e);r.end("<h1>Error after user confirmation e-mail: ")}})}else{r.end("<h1>Request is from unknown source");return}}else{r.end("<h1>No such user or confirmation is too late!");return}r.redirect("/")})}};