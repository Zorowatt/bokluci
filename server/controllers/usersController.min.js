var Users=require("mongoose").model("Users"),crypto=require("crypto"),nodemailer=require("nodemailer"),smtpTransport=require("nodemailer-smtp-transport");var transporter=nodemailer.createTransport(smtpTransport({service:"Gmail",auth:{user:"deffered1234@gmail.com",pass:"deffered4321"},tls:{rejectUnauthorized:false}}));function generateSalt(){return crypto.randomBytes(128).toString("base64")}function generateHashedPassword(e,r){var s=crypto.createHmac("sha1",e);return s.update(r).digest("hex")}function randomString(e){var r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var s=e;var n="";for(var o=0;o<s;o++){var a=Math.floor(Math.random()*r.length);n+=r.substring(a,a+1)}return n}module.exports={createUser:function(e,r,s){var n=e.body;if(n.password!=n.password.replace(/[^a-zA-Z0-9_<>?]/g,"")){r.send({success:false,reason:"Password contains forbidden symbols!"});r.end();return}if(n.password.length>16){r.send({success:false,reason:"Password is too long!"});r.end();return}Users.findOne({username:n.username}).exec(function(s,o){if(o){r.send({success:false,reason:"This username exists already!"});return}Users.findOne({email:n.email}).exec(function(s,o){if(o){r.send({success:false,reason:"User with this email address exists already!"});return}var a=e.headers["x-forwarded-for"];if(a){var t=a.split(",");a=t[t.length-1]}else{a=e.connection.remoteAddress}n.salt=generateSalt();n.hashPass=generateHashedPassword(n.salt,n.password);n.confirmedEmail=false;n.randomIdForEmailConfirmation=randomString(40);var i=new Date;n.expirationConfirmationTime=i.setHours(i.getHours()+24);n.host=e.get("host");n.passRecovered=true;n.registrationDetails=[{date:i,ipAddress:a}];Users.create(n,function(s,o){if(s){return r.send({success:false,reason:s.toString()})}r.send({success:true,reason:"Confirmation Message has been sent to your E-mail!"});var a="http://"+e.get("host")+"/verify?id="+n.randomIdForEmailConfirmation;var t={from:"Bokluci.bg <deffered1234@gmail.com>",to:n.email,subject:"Please confirm your Email account!",html:"Hello,<br> Please Click on the link to verify your email.<br><a href="+a+">Click here to verify</a><br> The confirmation should be done within 24 hours!"};transporter.sendMail(t,function(e,s){if(e){r.end("<h1>Email error: "+e)}});r.end()})})})},verifyUser:function(e,r,s){if(!e.query.id){r.end("<h1>Not authorized access!");return}if(e.query.id!==e.query.id.replace(/[^a-zA-Z0-9]/g,"")||e.query.id.length!=40){r.end("<h1>Do not try this at home!");return}Users.findOne({randomIdForEmailConfirmation:e.query.id}).exec(function(s,n){if(s){r.end("<h1>Error! Try again later");return}if(n){if(e.protocol+"://"+e.get("host")=="http://"+n.host){if(n.confirmedEmail){r.redirect("/");return}var o=new Date;if(o>n.expirationConfirmationTime){Users.remove({_id:n._id},function(e,r){if(e){console.log("Error after user removing: "+e)}});r.end("<h1>Confirmation is too late.<br> You have to create new account!");return}Users.update({_id:n._id},{confirmedEmail:true},function(e,s){if(e){console.log("Error after user confirmation e-mail: "+e);r.end("<h1>Error after user confirmation e-mail: ")}})}else{r.end("<h1>Request is from unknown source");return}}else{r.end("<h1>No such user or confirmation is too late!");return}r.render("verified")})},forgotUser:function(e,r,s){var n=e.body;var o=new Date;var a=randomString(40);if(n){Users.findOneAndUpdate({username:n.username},{randomIdForEmailConfirmation:a,expirationConfirmationTime:o.setHours(o.getHours()+24),passRecovered:false}).exec(function(e,s){if(e){r.end("<h1>DB error");return}if(s){r.send({success:true,reason:"Recovery Message has been sent to your E-mail!"});var t="http://"+s.host+"/recover?id="+a;var i={from:"Bokluci.bg <deffered1234@gmail.com>",to:s.email,subject:"Password recovery!",html:"Hello,<br>Your username is:     "+s.username+"<br> Please Click on the link to recover your password.<br><a href="+t+">Recovery link</a>"};transporter.sendMail(i,function(e,s){if(e){r.end("<h1>Email error: "+e)}});r.end()}else{Users.findOneAndUpdate({email:n.username},{randomIdForEmailConfirmation:a,expirationConfirmationTime:o.setHours(o.getHours()+24),passRecovered:false}).exec(function(e,s){if(e){r.end("<h1>DB error");return}if(s){r.send({success:true,reason:"Recovery Message has been sent to your E-mail!"});var n="http://"+s.host+"/recover?id="+a;var o={from:"Bokluci.bg <deffered1234@gmail.com>",to:s.email,subject:"Password recovery!",html:"Hello,<br>Your username is:     "+s.username+"<br> Please Click on the link to recover your password.<br><a href="+n+">Recovery link</a>"};transporter.sendMail(o,function(e,s){if(e){r.end("<h1>Email error: "+e)}});r.end()}else{r.send({success:false,reason:"no such user"});r.end()}})}})}else{r.end("<h1>Do not try that!")}},recoverUser:function(e,r,s){if(!e.query.id){r.redirect("/");return}if(e.query.id!==e.query.id.replace(/[^a-zA-Z0-9]/g,"")||e.query.id.length!=40){r.redirect("/");return}Users.findOne({randomIdForEmailConfirmation:e.query.id}).exec(function(s,n){if(s){r.end("<h1>Error! Try again later");return}if(n){if(e.protocol+"://"+e.get("host")=="http://"+n.host){if(n.passRecovered){r.redirect("/");return}var o=new Date;if(o>n.expirationConfirmationTime){n.passRecovered=true;n.save();r.end("<h1>Password recovery is too late!");return}r.render("index")}else{r.redirect("/");return}}else{r.redirect("/")}})},verifyAndRecoverUser:function(e,r,s){var n=e.body;if(!n.password){r.send({success:true,reason:"OK"});r.end()}if(n.password.length==0){r.send({success:true,reason:"OK"});r.end()}if(n.password!=n.password.replace(/[^a-zA-Z0-9_<>?]/g,"")){r.send({success:false,reason:"Password contains forbidden symbols!"});r.end();return}if(n.password.length>16){r.send({success:false,reason:"Password is too long!"});r.end();return}var o=generateSalt();Users.findOneAndUpdate({randomIdForEmailConfirmation:n.id,passRecovered:false},{passRecovered:true,salt:o,hashPass:generateHashedPassword(o,n.password)}).exec(function(e,s){if(e){r.send({success:false,reason:"Sorry, try again later!"});return}if(s){r.send({success:true,reason:"OK"});r.end()}else{r.send({success:true,reason:"OK"});r.end()}})}};