var Users=require("mongoose").model("Users"),crypto=require("crypto"),nodemailer=require("nodemailer"),smtpTransport=require("nodemailer-smtp-transport");var transporter=nodemailer.createTransport(smtpTransport({service:"Gmail",auth:{user:"deffered1234@gmail.com",pass:"deffered4321"},tls:{rejectUnauthorized:false}}));function generateSalt(){return crypto.randomBytes(128).toString("base64")}function generateHashedPassword(e,r){var s=crypto.createHmac("sha1",e);return s.update(r).digest("hex")}function randomString(e){var r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var s=e;var o="";for(var n=0;n<s;n++){var a=Math.floor(Math.random()*r.length);o+=r.substring(a,a+1)}return o}module.exports={createUser:function(e,r,s){var o=e.body;if(o.password!=o.password.replace(/[^a-zA-Z0-9_<>?]/g,"")){r.send({success:false,reason:"Password contains forbidden symbols!"});r.end();return}if(o.password.length>16){r.send({success:false,reason:"Password is too long!"});r.end();return}Users.findOne({username:o.username}).exec(function(s,n){if(n){r.send({success:false,reason:"This username exists already!"});return}Users.findOne({email:o.email}).exec(function(s,n){if(n){r.send({success:false,reason:"User with this email address exists already!"});return}var a=e.headers["x-forwarded-for"];if(a){var t=a.split(",");a=t[t.length-1]}else{a=e.connection.remoteAddress}console.log(o);o.salt=generateSalt();o.hashPass=generateHashedPassword(o.salt,o.password);o.confirmedEmail=false;o.randomIdForEmailConfirmation=randomString(40);var i=new Date;o.expirationConfirmationTime=i.setHours(i.getHours()+24);o.host=e.get("host");o.passRecovered=true;o.registrationDetails=[{date:i,ipAddress:a}];console.log(a);Users.create(o,function(s,n){if(s){return r.send({success:false,reason:s.toString()})}r.send({success:true,reason:"Confirmation Message has been sent to your E-mail!"});var a="http://"+e.get("host")+"/verify?id="+o.randomIdForEmailConfirmation;var t={from:"Bokluci.bg <deffered1234@gmail.com>",to:o.email,subject:"Please confirm your Email account!",html:"Hello,<br> Please Click on the link to verify your email.<br><a href="+a+">Click here to verify</a><br> The confirmation should be done within 24 hours!"};transporter.sendMail(t,function(e,s){if(e){r.end("<h1>Email error: "+e)}});r.end()})})})},verifyUser:function(e,r,s){if(!e.query.id){r.end("<h1>Not authorized access!");return}if(e.query.id!==e.query.id.replace(/[^a-zA-Z0-9]/g,"")||e.query.id.length!=40){r.end("<h1>Do not try this at home!");return}Users.findOne({randomIdForEmailConfirmation:e.query.id}).exec(function(s,o){if(s){r.end("<h1>Error! Try again later");return}if(o){if(e.protocol+"://"+e.get("host")=="http://"+o.host){if(o.confirmedEmail){r.redirect("/");return}var n=new Date;if(n>o.expirationConfirmationTime){Users.remove({_id:o._id},function(e,r){if(e){console.log("Error after user removing: "+e)}});r.end("<h1>Confirmation is too late.<br> You have to create new account!");return}Users.update({_id:o._id},{confirmedEmail:true},function(e,s){if(e){console.log("Error after user confirmation e-mail: "+e);r.end("<h1>Error after user confirmation e-mail: ")}})}else{r.end("<h1>Request is from unknown source");return}}else{r.end("<h1>No such user or confirmation is too late!");return}r.render("verified")})},forgotUser:function(e,r,s){var o=e.body;var n=new Date;var a=randomString(40);if(o){Users.findOneAndUpdate({username:o.username},{randomIdForEmailConfirmation:a,expirationConfirmationTime:n.setHours(n.getHours()+24),passRecovered:false}).exec(function(e,s){if(e){r.end("<h1>DB error");return}if(s){r.send({success:true,reason:"Recovery Message has been sent to your E-mail!"});var t="http://"+s.host+"/recover?id="+a;var i={from:"Bokluci.bg <deffered1234@gmail.com>",to:s.email,subject:"Password recovery!",html:"Hello,<br>Your username is:     "+s.username+"<br> Please Click on the link to recover your password.<br><a href="+t+">Recovery link</a>"};transporter.sendMail(i,function(e,s){if(e){r.end("<h1>Email error: "+e)}});r.end()}else{Users.findOneAndUpdate({email:o.username},{randomIdForEmailConfirmation:a,expirationConfirmationTime:n.setHours(n.getHours()+24),passRecovered:false}).exec(function(e,s){if(e){r.end("<h1>DB error");return}if(s){r.send({success:true,reason:"Recovery Message has been sent to your E-mail!"});var o="http://"+s.host+"/recover?id="+a;var n={from:"Bokluci.bg <deffered1234@gmail.com>",to:s.email,subject:"Password recovery!",html:"Hello,<br>Your username is:     "+s.username+"<br> Please Click on the link to recover your password.<br><a href="+o+">Recovery link</a>"};transporter.sendMail(n,function(e,s){if(e){r.end("<h1>Email error: "+e)}});r.end()}else{r.send({success:false,reason:"no such user"});r.end()}})}})}else{r.end("<h1>Do not try that!")}},recoverUser:function(e,r,s){if(!e.query.id){r.redirect("/");return}if(e.query.id!==e.query.id.replace(/[^a-zA-Z0-9]/g,"")||e.query.id.length!=40){r.redirect("/");return}Users.findOne({randomIdForEmailConfirmation:e.query.id}).exec(function(s,o){if(s){r.end("<h1>Error! Try again later");return}if(o){if(e.protocol+"://"+e.get("host")=="http://"+o.host){if(o.passRecovered){r.redirect("/");return}var n=new Date;if(n>o.expirationConfirmationTime){o.passRecovered=true;o.save();r.end("<h1>Password recovery is too late!");return}r.render("index")}else{r.redirect("/");return}}else{r.redirect("/")}})},verifyAndRecoverUser:function(e,r,s){var o=e.body;console.log(o);if(!o.password){r.send({success:true,reason:"OK"});r.end()}if(o.password.length==0){r.send({success:true,reason:"OK"});r.end()}if(o.password!=o.password.replace(/[^a-zA-Z0-9_<>?]/g,"")){r.send({success:false,reason:"Password contains forbidden symbols!"});r.end();return}if(o.password.length>16){r.send({success:false,reason:"Password is too long!"});r.end();return}var n=generateSalt();Users.findOneAndUpdate({randomIdForEmailConfirmation:o.id,passRecovered:false},{passRecovered:true,salt:n,hashPass:generateHashedPassword(n,o.password)}).exec(function(e,s){if(e){r.send({success:false,reason:"Sorry, try again later!"});return}if(s){r.send({success:true,reason:"OK"});r.end()}else{r.send({success:true,reason:"OK"});r.end()}})}};